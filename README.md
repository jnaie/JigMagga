![JigMagga](media/img/jigMagga.jpg)

JigMagga
========

_JigMagga_ is a widget based configuration file driven frontend JavaScript MVC framework.

It uses all technologies of [bitovi JavaScript MVC](https://github.com/bitovi/javascriptmvc) ([canJS], [steal], [funcunit], [documentJS])
but replaces the core JavaScript MVC parts like the generator and the deployment by [Grunt] tasks or serverside workers.

Widgets in JigMagga are called jigs. They can be rendered in the frontend application and/or because of SEO reasons get prerendered on serverside. This can be decided in the configuration. This means that _JigMagga_ is designed to *not* be a single page application framework. It produces a lot of prerendered pages with a optimal frontend application on each page.

For styling there is a on the fly SASS compiler bundled.

JigMagga has it's own build in [Grunt] webserver, but can also be used with Apache.

For the deploy a [Grunt] task is used. It generates one merged and minified JS file and one CSS file.
 
The HTML is generated by workers that can be either called directly or be triggered by a [RabbitMQ].

All static files (HTML, JS, CSS and other assets) are stored to a CDN.

_JigMagga_ is build for SEO compatible multi language multi domain sites with a huge load.

[Grunt]: http://gruntjs.com/
[canJS]: https://github.com/bitovi/canjs "canJS in GitHub"
[steal]: https://github.com/bitovi/steal "steal in GitHub"
[funcunit]: https://github.com/bitovi/funcunit "funcunit in GitHub"
[documentJS]: https://github.com/bitovi/documentjs "documentJS in GitHub"
[RabbitMQ]: http://www.rabbitmq.com/
[nodeJS]: http://nodejs.org/

Who uses JigMagga?
------------------

![lieferando](http://www.lieferando.de/yd/media/img/yd-jig-header/logo-big-dach.png)
![pyszne.pl](http://pyszne.pl/yd/media/img/yd-jig-header/logo-big-pl.png)
![lieferservice.de](http://www.lieferando.de/yd/media/img/yd-jig-header/logo-big-lieferservice.de.png)

Example configuration for generating pages
------------------------------------------

This is currently the workflow at all takeaway plattforms that use _JigMagga_.

![JigMagga](media/img/jigMaggaWorkflow.jpg)

It uses several queues and workers generating the different domains and pushing the pages to the CDN
 
![JigMagga](media/img/jigMaggaWorkflow.jpg)

Getting started
===============

_JigMagga_ is easy to install and works without any special environment but [nodeJS] and [git](http://git-scm.com/) if you want to update your local version. You can also download _JigMagga_ as a [ZIP file](https://github.com/yourdelivery/JigMagga/archive/master.zip).  
We didn't yet test in on windows, but this should also work.  
To run the [Grunt] processes easier, you can install grunt-cli globally (use sudo in debian and MacOS based system).

    npm install -g grunt-cli

Installation
------------

To install JigMagga clone the repository and run `npm install`

    git clone git@github.com:yourdelivery/JigMagga.git JigMagga
    cd JigMagga
    npm install
        
Start JigMagga
--------------

To start JigMagga webserver just type

        grunt connect
        
It should automatically open your browser. If it doesn't go to `http://0.0.0.0:8000`.

If you run it the first time it shows this file. After you created a project, it shows the first index page.
 
Generate projects, pages and jigs
=================================

To generate your project just call

        grunt generate
        
The generator will guide you through the generation of parts of your project.

Generating a new project
------------------------

To generate a project only a namespace is needed. Choose a short namespace, because this namespace Is not only used in the JavaScript code, but also in CSS and HTML. It will make your code longer. A two letter namespace is a good choice.

The generator will make a new project folder in the main _JigMagga_ folder. Inside the folder it will generate a new pages folder with a default domain folder and an index page folder and an index page.

As _JigMagga_ is config based, it creates config files in page folder and index folder. The project wide page configuration will contain the namespace. The page config contains an empty object for jigs.

The index HTML page will contain the call to the JS and over that to the config and some sections that use the _JigMagga_ grid.

After a project Is generated, grunt connect will call the new index page instead of this File.


Generating a domain
-------------------

When generating a domain you have to give the namespace and a domain name. The domain name can contain a slash if you want to group domains in folders. 

The generator will now generate the domain folder with the corresponding config file in the pages folder. 

Generating a page
-----------------

Generating a page also requests for the namespace and a name of the page. It also asks in which domain the page should get rendered.

If you want to group pages, you can use slashes to create folders.

The generated config file is empty. The generated JavaScript file just contains a steal of the config file. The HTML page contains sample HTML.

Generating a jig
----------------

To generate a Jig, the namespace, a jig name and a page to render the jig in is needed.
 
The generator will add the initial jig configuration in the selected page.
  
The generator generates a the initial jig and two pages to run the testcases. Also the initial testcase JavaScript file is generated.

Generating a model
------------------

Generating of a model only needs a namespace an a name for the model. It will generate a folder in the models folder, named as the model. In the folder there is an empty model JavasScript, a testcase JavaScript and a testcase HTML page.

Generating a locale
-------------------

Locales are generated by domain. The po files resist in the locales folder. Locales should be named in the form en_EN (lowercase language, uppercase country).

When generating a locale for a domain, the locale gets inserted in the domain config.

Generating a repository
-----------------------

When creating a project, the namespace folder is put into the `.gitignore` file. With the generate repository option a project folder can be put into github as a repository.

Stealing files
==============

_JigMagga_ uses bitovi's [Steal] for the dependency management in the frontend application. [Steal] is build upon [SystemJS](https://github.com/systemjs/systemjs) and can map files to plugins.

Steal comes bundled with plugins for CSS, [LESS](http://lesscss.org), [EJS](http://embeddedjs.com/), [Mustache](http://mustache.github.io/) and [CoffeScript](http://coffeescript.org/). 

_JigMagga_ adds plugins for [gettext](http://de.wikipedia.org/wiki/GNU_gettext) po files, [SASS](http://sass-lang.com/) and _JigMagga_ configuration files.

    steal(
        "can/control",
        "./css/init.scss",
        "./views/init.mustache",
        function (can) {
            $("body").html(can.view("./views/init.mustache");
        }
    );
This will convert the SASS file "init.scss" and puts it in the HTML file head. Then it will convert the Mustache template "./views/init.mustache" to HTML and puts it into the body.

The file stealconfig.js in the root directory contains the following mapping.

    ext: {
            scss: "steal-types/sass/sass.js",
            less: "steal-types/less/less.js",
            ejs: "can/view/ejs/ejs.js",
            mustache: "can/view/mustache/mustache.js",
            coffee: "steal/coffee/coffee.js",
            conf: "steal-types/conf/conf.js",
            po: "steal-types/po/po.js"
    }

Stealing a conf file mostly makes sense when doing it as the first steal in a page. See next chapter for config files.

Normally the po file for a page gets stealed by the conf file plugin and not by itself. See the locales chapter for more information.

When stealing a SASS or LESS file after stealing a config file, it is possible to define SASS or LASS variables in the config.  
Therefore the steal LESS plugin is not called directly.  
It then also renders the current domain and locale to SASS.

    less: {
        "color1": "#FFFFFF",
        "color0": "#000000"
    }
when namespace is "jm" the above results in the following code placed at the beginning of every SASS import.

    $color1: #FFFFFF;
    $color0: #000000;
    $jm-domain: domain.com
    $jm-locale: en_EN


Pages and config files
======================

The configuration files are the heart of _JigMagga_. They define and start jigs. Normally one configuration file is stealed at the beginning of the application. The application itself stays empty.

        steal('./index.conf');

A configuration file is a simple JSON file with the extension `conf`. It holds the configuration for pages and jigs and can store everything else you need in your namespace.

The configuration is build in a hierarchical system. A normal setup with a namespace called `jm` and one domain called `domain1.com`looks like this:

    jm/
        page/
            default/
                index/
                    index.conf
                    index.html
                    index.js
            domain1.com/
                index/
                    index.conf
                domain1.com.conf
            page.conf
        
This describes a namespace with a single domain and a single index page. The root configuration is the `page.conf`. It normally only holds the namespace definition.

    {
        "namespace": "jm"
    }
    
The domain configuration file `domain1.com.conf` contains the pages configuration. If we would have two locales `en_EN` and `fr_FR` it will look like this:

    {
        "pages": {
            "index": {"en_EN": "/", "fr_FR": "/fr/}
        }
    }

That means after the deploy process this singe index page will get deployed for English under `http://domain1.com/` and for French under `http://domain1.com/fr/`.
The domain.conf is also a good place to define domain wide includes and SASS variables:

    {
        "pages": {...}
        "includes": ["/jm/lib/lib1.js", "/jm/lib/lib2.js"]
        "sass": {
            "mobilepage": true,
            "header-color": "#FF0000"
        }
    }

The hierarchical system
-----------------------

The page configuration mainly holds the jigs configuration for one page. 
That doesn't mean that the jig config can only resist in a page configuration. 
It can resist on every config file in the hierarchy. 
If one jig like the header should get rendered an every page in the namespace, 
you can define it in the `page.conf`. If all pages in the domain `domain1.com` should have the same footer,
you can define them in the `domain1.com.conf`.

The configuration plugin always bubbles through the whole tree to one page in default mode and in domain mode. 
It starts with the `page.conf` of a name space and merges first all configs together up to the given page in 
the default folder and then merges all configs up to the given page in the domain folder of the given domain.
Merging is done with a deep extend functionality.  
Levels in the tree without a config file just don't get merged.

If you call `grunt connect` it opens the first index page in the first domain, if it exists.

If the HTML page in the page folder under the domain folder doesn't exist, it uses the one on the default folder.

Jigs
====
- wo und wie gerendert
- jig initialisieren in code (neue art)

Views
-----
- view rendern

If you want to jump to a specific page in the current language

- links to other pages


Models
======

caching/getCurrent

Live binding
------------

Late live binding
-----------------

Using locales
=============



Jig interaction
===============

Mediator (TBD)

Styling with SASS
=================

Grid -> benni!

Testing
=======

For testing we used [funcunit](http://funcunit.com/) which is a extension for [Qunit](http://qunitjs.com/).
Every jig have a funcunit.html page that represent the Qunit test suite.
This page will load a *_test.js from the jig wich include the test implementation.
Take sure that your browser do not block popups! The *_test.js will open a new window with the jig environment.
You can run the testcases from a jig by open the funcunit.html page in your favorit browser.
It is also possible to run the testcases from the command line with [testem](https://github.com/airportyh/testem) or use the grunt task (grunt test) for it.
The configuration for testem is located in testem.json in the JigMagger root directory.

**Naming conventions for testcases:**

- Module names have a dot notation eg. Jig.Lightbox



Building the project
====================

Building the project is done by Grunt

        grunt build
        
-> upload?
        
The build process buildes one JavaScript file and one CSS file and uploads it to the CDN. The generation of HTML pages is done by the HTML worker.  

HTML-Workers
------------

- statische seiten
- queue


You want to join the JigMagga team?
===================================

Please take a look at our Jobs page at [lieferando](http://www.lieferando.de/jobs).
If you want to use JigMagga and want to make bug fixes and improvements, we are welcome for [pull requests](https://help.github.com/articles/using-pull-requests).

Coding conventions
------------------
* Use 4 spaces instead of tabs.
* Commas last.
* Use double quotes instead of single quotes where possible.

License
=======
_JigMagga_ is released under the MIT licence. 
